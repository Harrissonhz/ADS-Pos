<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ADS-POS</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Estilos principales del proyecto y POS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/pos.css">
    <link rel="icon" href="../assets/img/logo.png">
    <meta name="description" content="Dashboard principal del sistema POS ADS-POS">
</head>
<body class="pos-app">
    <!-- Menú hamburguesa -->
    <nav class="pos-navbar">
        <div class="pos-navbar-brand">
            <button class="btn btn-link pos-menu-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#posSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="pos-navbar-actions">
            <a href="./Menu.html" class="btn btn-link pos-home-btn" title="Ir al Menu">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="offcanvas offcanvas-start pos-sidebar" tabindex="-1" id="posSidebar">
        <div class="offcanvas-header pos-sidebar-header">
            <div class="d-flex align-items-center gap-2">
                <img src="../assets/img/logo.png" alt="Logo ADS" class="pos-sidebar-logo">
                <h5 class="mb-0">ADS Store POS</h5>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body pos-sidebar-body">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="./panel.html">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./ventas.html">
                        <i class="fas fa-shopping-cart me-2"></i>Ventas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./facturacion.html">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Facturación
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./ventas-historial.html">
                        <i class="fas fa-history me-2"></i>Historial de Ventas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-header-collapse" data-bs-toggle="collapse" href="#inventarioMenu" role="button" aria-expanded="false" aria-controls="inventarioMenu">
                        <i class="fas fa-warehouse me-2"></i>Inventario
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="inventarioMenu">
                        <ul class="nav flex-column ms-3">
                            <li class="nav-item">
                                <a class="nav-link" href="./productos.html">
                                    <i class="fas fa-box me-2"></i>Productos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./categorias.html">
                                    <i class="fas fa-tags me-2"></i>Categorías
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./inventario.html">
                                    <i class="fas fa-warehouse me-2"></i>Inventario
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./movimientos.html">
                                    <i class="fas fa-exchange-alt me-2"></i>Movimientos
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-header-collapse" data-bs-toggle="collapse" href="#clientesProveedoresMenu" role="button" aria-expanded="false" aria-controls="clientesProveedoresMenu">
                        <i class="fas fa-users me-2"></i>Clientes y Proveedores
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="clientesProveedoresMenu">
                        <ul class="nav flex-column ms-3">
                            <li class="nav-item">
                                <a class="nav-link" href="./clientes.html">
                                    <i class="fas fa-users me-2"></i>Clientes
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./proveedores.html">
                                    <i class="fas fa-truck me-2"></i>Proveedores
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./compras.html">
                                    <i class="fas fa-shopping-bag me-2"></i>Compras
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-header-collapse" data-bs-toggle="collapse" href="#cajaFinanzasMenu" role="button" aria-expanded="false" aria-controls="cajaFinanzasMenu">
                        <i class="fas fa-cash-register me-2"></i>Caja y Finanzas
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="cajaFinanzasMenu">
                        <ul class="nav flex-column ms-3">
                            <li class="nav-item">
                                <a class="nav-link" href="./caja-apertura.html">
                                    <i class="fas fa-cash-register me-2"></i>Apertura de Caja
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./caja-cierre.html">
                                    <i class="fas fa-lock me-2"></i>Cierre de Caja
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./caja-historial.html">
                                    <i class="fas fa-chart-line me-2"></i>Historial de Caja
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./gastos.html">
                                    <i class="fas fa-money-bill-wave me-2"></i>Gastos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./reportes.html">
                                    <i class="fas fa-chart-bar me-2"></i>Reportes
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-header-collapse" data-bs-toggle="collapse" href="#configuracionMenu" role="button" aria-expanded="false" aria-controls="configuracionMenu">
                        <i class="fas fa-cog me-2"></i>Configuración
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <div class="collapse" id="configuracionMenu">
                        <ul class="nav flex-column ms-3">
                            <li class="nav-item">
                                <a class="nav-link" href="./usuarios.html">
                                    <i class="fas fa-user-cog me-2"></i>Usuarios
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./configuracion.html">
                                    <i class="fas fa-cog me-2"></i>Configuración
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./perfil.html">
                                    <i class="fas fa-user me-2"></i>Perfil
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./ayuda.html">
                                    <i class="fas fa-question-circle me-2"></i>Ayuda
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="nav-item mt-3">
                    <a class="nav-link" href="../index.html">
                        <i class="fas fa-home me-2"></i>Volver a Tienda
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Contenido Principal -->
    <main class="container-fluid py-4">
        <div>
            <div class="pos-login-header d-flex align-items-center position-relative">
                <h2 class="w-100 text-center mb-0">Dashboard Principal</h2>
                <div class="logo-icon position-absolute end-0">
                    <img src="../assets/img/logo.png" alt="Logo ADS" class="pos-logo-img">
                </div>
            </div>

            <!-- Información de Bienvenida -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card pos-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-12 col-md-8 mb-3 mb-md-0">
                                    <h4 class="text-white mb-2">¡Bienvenido al Sistema POS!</h4>
                                    <p class="text-white-50 mb-0">Aquí tienes un resumen completo de tu negocio. Última actualización: <span id="fechaActual"></span></p>
                                </div>
                                <div class="col-12 col-md-4 text-md-end">
                                    <div class="btn-group w-100 w-md-auto" role="group">
                                        <button class="btn btn-primary" onclick="actualizarDashboard()">
                                            <i class="fas fa-sync-alt me-2"></i>Actualizar Datos
                                        </button>
                                        <a href="./Menu.html" class="btn btn-outline-light ms-2">
                                            <i class="fas fa-home me-2"></i>Home
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPIs Principales (Mes Actual) -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card pos-card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>KPIs Principales</h5>
                                <small class="text-white-50">Indicadores financieros del mes actual</small>
                            </div>
                            <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="collapse" data-bs-target="#kpiFinancieros" aria-expanded="true" aria-controls="kpiFinancieros">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="card-body collapse show" id="kpiFinancieros">
                            <div class="row g-4 justify-content-center">
                                <div class="col-12 col-lg-2 col-md-6 text-center">
                                    <i class="fas fa-dollar-sign fa-3x text-success mb-2"></i>
                                    <h3 id="kpiVentasMes" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Ventas del Mes</p>
                                    <small class="text-white-50">Mes actual</small>
                                </div>
                                <div class="col-12 col-lg-2 col-md-6 text-center">
                                    <i class="fas fa-wallet fa-3x text-danger mb-2"></i>
                                    <h3 id="kpiGastosMes" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Gastos del Mes</p>
                                    <small class="text-white-50">Mes actual</small>
                                </div>
                                <div class="col-12 col-lg-2 col-md-6 text-center">
                                    <i class="fas fa-shopping-bag fa-3x text-warning mb-2"></i>
                                    <h3 id="kpiComprasMes" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Compras del Mes</p>
                                    <small class="text-white-50">Mes actual</small>
                                </div>
                                <div class="col-12 col-lg-2 col-md-6 text-center">
                                    <i class="fas fa-exchange-alt fa-3x text-primary mb-2"></i>
                                    <h3 id="kpiFlujoOperativoMes" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Flujo Operativo</p>
                                    <small class="text-white-50">Mes actual</small>
                                </div>
                                <div class="col-12 col-lg-2 col-md-6 text-center">
                                    <i class="fas fa-coins fa-3x text-info mb-2"></i>
                                    <h3 id="kpiUtilidadNetaMes" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Utilidad Neta</p>
                                    <small class="text-white-50">Mes actual</small>
                                </div>
                                <div class="col-12 col-lg-2 col-md-6 text-center">
                                    <i class="fas fa-balance-scale fa-3x text-secondary mb-2"></i>
                                    <h3 id="kpiMargenUtilidadMes" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Margen de Utilidad</p>
                                    <small class="text-white-50">Mes actual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPIs Financieros Comparativos -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card pos-card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>KPIs Financieros Comparativos</h5>
                                <small class="text-white-50">Análisis comparativo y tendencias financieras</small>
                            </div>
                            <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="collapse" data-bs-target="#kpiFinancierosComparativos" aria-expanded="true" aria-controls="kpiFinancierosComparativos">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="card-body collapse show" id="kpiFinancierosComparativos">
                            <div class="row g-4 justify-content-center">
                                <div class="col-12">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                                        <h6 class="text-white mb-0"><i class="fas fa-chart-line me-2"></i>Ventas Mensuales</h6>
                                        <div class="d-flex align-items-center gap-2">
                                            <label class="text-white-50 mb-0">Año:</label>
                                            <select class="form-select form-select-sm" id="selectAnioVentas" style="width: auto; min-width: 100px;">
                                                <!-- Se llenará dinámicamente -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center">
                                        <div style="position: relative; height: 300px; width: 100%; max-width: 100%;" class="chart-container-responsive">
                                            <canvas id="ventasMensualesChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                                        <h6 class="text-white mb-0"><i class="fas fa-chart-bar me-2"></i>Análisis de Flujo: Ventas, Gastos y Flujo Operativo</h6>
                                        <div class="d-flex align-items-center gap-2">
                                            <label class="text-white-50 mb-0">Año:</label>
                                            <select class="form-select form-select-sm" id="selectAnioFlujoOperativo" style="width: auto; min-width: 100px;">
                                                <!-- Se llenará dinámicamente -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center">
                                        <div style="position: relative; height: 300px; width: 100%; max-width: 100%;" class="chart-container-responsive">
                                            <canvas id="flujoOperativoChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-4">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                                        <h6 class="text-white mb-0"><i class="fas fa-chart-bar me-2"></i>Comparación de Ventas por Año</h6>
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <label class="text-white-50 mb-0">Año 1:</label>
                                            <select class="form-select form-select-sm" id="selectAnioComparativo1" style="width: auto; min-width: 100px;">
                                                <!-- Se llenará dinámicamente -->
                                            </select>
                                            <label class="text-white-50 mb-0 ms-2">Año 2:</label>
                                            <select class="form-select form-select-sm" id="selectAnioComparativo2" style="width: auto; min-width: 100px;">
                                                <!-- Se llenará dinámicamente -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center">
                                        <div style="position: relative; height: 300px; width: 100%; max-width: 100%;" class="chart-container-responsive">
                                            <canvas id="ventasComparativasChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPIs Operativos (Tiempo Real/Día a Día) -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card pos-card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>KPIs Operativos</h5>
                                <small class="text-white-50">Indicadores en tiempo real del día actual</small>
                            </div>
                            <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="collapse" data-bs-target="#kpiOperativos" aria-expanded="true" aria-controls="kpiOperativos">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="card-body collapse show" id="kpiOperativos">
                            <div class="row g-4">
                                <div class="col-12 col-lg-3 col-md-6 text-center">
                                    <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                                    <h3 id="kpiVentasTotales" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Ventas Totales</p>
                                    <small class="text-white-50">Suma de todas las ventas</small>
                                </div>
                                <div class="col-lg-3 col-md-6 text-center">
                                    <i class="fas fa-wallet fa-2x text-danger mb-2"></i>
                                    <h3 id="kpiGastosTotales" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Gastos Totales</p>
                                    <small class="text-white-50">Suma de todos los gastos</small>
                                </div>
                                <div class="col-lg-3 col-md-6 text-center">
                                    <i class="fas fa-balance-scale fa-2x text-warning mb-2"></i>
                                    <h3 id="kpiPuntoEquilibrioTotal" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Punto Equilibrio Total</p>
                                    <small class="text-white-50">Ventas - Gastos</small>
                                </div>
                                <div class="col-lg-3 col-md-6 text-center">
                                    <i class="fas fa-triangle-exclamation fa-2x text-danger mb-2"></i>
                                    <h3 id="kpiStockBajo" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Productos con Stock Bajo</p>
                                    <small class="text-white-50">—</small>
                                </div>
                                <div class="col-lg-3 col-md-6 text-center">
                                    <i class="fas fa-cubes fa-2x text-info mb-2"></i>
                                    <h3 id="kpiTotalProductos" class="text-white">—</h3>
                                    <p class="text-white-50 mb-1">Total Productos</p>
                                    <small class="text-white-50">—</small>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos Principales -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card pos-card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-line me-2"></i>
                                <h5 class="mb-0">Ventas de los Últimos 7 Días</h5>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-light active" onclick="cambiarPeriodo('7d')">7D</button>
                                <button class="btn btn-sm btn-outline-light" onclick="cambiarPeriodo('30d')">30D</button>
                                <button class="btn btn-sm btn-outline-light" onclick="cambiarPeriodo('90d')">90D</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="ventasChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accesos Rápidos -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card pos-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-bolt me-2"></i>
                            <h5 class="mb-0">Accesos Rápidos</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <a href="./facturacion.html" class="btn btn-success w-100">
                                        <i class="fas fa-file-invoice me-2"></i>Nueva Factura
                                    </a>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <a href="./ventas.html" class="btn btn-primary w-100">
                                        <i class="fas fa-shopping-cart me-2"></i>Nueva Venta
                                    </a>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <a href="./caja-apertura.html" class="btn btn-warning w-100">
                                        <i class="fas fa-unlock me-2"></i>Abrir Caja
                                    </a>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <a href="./productos.html" class="btn btn-info w-100">
                                        <i class="fas fa-box me-2"></i>Productos
                                    </a>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <a href="./clientes.html" class="btn btn-secondary w-100">
                                        <i class="fas fa-users me-2"></i>Clientes
                                    </a>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <a href="./reportes.html" class="btn btn-dark w-100">
                                        <i class="fas fa-chart-bar me-2"></i>Reportes
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <div class="text-center mt-4 pos-login-footer">
        <a href="../index.html" class="text-decoration-none"><i class="fas fa-home me-2"></i>Volver a la tienda</a>
        <div class="text-center mt-3"></div>
            <a href="https://www.facebook.com/profile.php?id=61550078453724" class="text-white me-3" target="_blank"><i class="fab fa-facebook fa-2x"></i></a>
            <a href="https://www.instagram.com/OutletShop_for_my/" class="text-white me-3" target="_blank"><i class="fab fa-instagram fa-2x"></i></a>
            <a href="https://www.youtube.com/@OutletShopTiendaVirtual" class="text-white me-3" target="_blank"><i class="fab fa-youtube fa-2x"></i></a>
            <a href="https://tiktok.com/@outletshoptienda" class="text-white me-3" target="_blank"><i class="fab fa-tiktok fa-2x"></i></a>
        </div>
        <div class="text-center mt-3">
            <p class="text-white-50 mb-0">
                <i class="fas fa-copyright me-1"></i>
                2024 ADS-POS. Sistema de Punto de Venta Profesional.
            </p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js?v=8"></script>
    <script src="../assets/js/database.js?v=12"></script>
    <script src="../assets/js/auth.js?v=8"></script>
    <script>
        // Prevenir el parpadeo del offcanvas
        document.addEventListener('DOMContentLoaded', function() {
            const offcanvasElement = document.getElementById('posSidebar');
            if (offcanvasElement) {
                const offcanvas = new bootstrap.Offcanvas(offcanvasElement);
                
                // Manejar eventos del offcanvas
                offcanvasElement.addEventListener('show.bs.offcanvas', function() {
                    this.classList.add('show');
                });
                
                offcanvasElement.addEventListener('hide.bs.offcanvas', function() {
                    this.classList.remove('show');
                });
            }

            // Sincronizar chevrons de los colapsos de KPIs
            const collapseElements = ['kpiFinancieros', 'kpiFinancierosComparativos', 'kpiOperativos'];
            collapseElements.forEach(id => {
                const collapseElement = document.getElementById(id);
                if (collapseElement) {
                    const header = collapseElement.previousElementSibling;
                    const button = header?.querySelector('button[data-bs-toggle="collapse"]');
                    const chevron = button?.querySelector('.fa-chevron-up, .fa-chevron-down');
                    
                    if (chevron) {
                        collapseElement.addEventListener('show.bs.collapse', function() {
                            chevron.classList.remove('fa-chevron-down');
                            chevron.classList.add('fa-chevron-up');
                        });
                        
                        collapseElement.addEventListener('hide.bs.collapse', function() {
                            chevron.classList.remove('fa-chevron-up');
                            chevron.classList.add('fa-chevron-down');
                        });
                    }
                }
            });
        });
    </script>
    <script>
        // Configurar fecha actual y cargar KPIs
        document.addEventListener('DOMContentLoaded', async function() {
            const fecha = new Date();
            const opciones = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('fechaActual').textContent = fecha.toLocaleDateString('es-ES', opciones);
            
            // Inicializar selectores de año
            inicializarSelectorAnio();
            inicializarSelectoresComparativos();
            inicializarSelectorAnioFlujoOperativo();
            
            // Cargar KPIs financieros
            await cargarKPIsFinancieros();
            
            // Cargar KPIs operativos
            await cargarKPIsOperativos();
            
            // Cargar KPIs comparativos (usará el año por defecto del selector)
            await cargarKPIsComparativos();
            
            // Cargar gráfico comparativo de años
            await cargarVentasComparativas();
            
            // Cargar gráfico de flujo operativo
            await cargarFlujoOperativoMensual();
            
            // Inicializar gráficos
            inicializarGraficos();
        });

        // Función para formatear moneda en COP
        function formatearMoneda(valor) {
            if (valor === null || valor === undefined || isNaN(valor)) {
                return '$ 0';
            }
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        // Función para formatear porcentaje
        function formatearPorcentaje(valor) {
            if (valor === null || valor === undefined || isNaN(valor)) {
                return '0.00%';
            }
            return `${Number(valor).toFixed(2)}%`;
        }

        // Función para cargar KPIs financieros del mes actual
        async function cargarKPIsFinancieros() {
            try {
                if (!window.db || !window.supabaseClient) {
                    console.error('No hay conexión con el servicio de base de datos');
                    return;
                }

                const fecha = new Date();
                const anio = fecha.getFullYear();
                const mes = fecha.getMonth() + 1; // getMonth() devuelve 0-11

                // Obtener datos de finanzas mensuales del mes actual
                const { data: finanzas, error } = await window.db.getFinanzasMensuales(anio, mes);

                if (error) {
                    console.error('Error cargando finanzas mensuales:', error);
                    mostrarErrorKPIs();
                    return;
                }

                // Si no hay datos para el mes actual, mostrar ceros
                if (!finanzas) {
                    actualizarKPIs({
                        ventas_netas: 0,
                        gastos_operativos_total: 0,
                        compras_total: 0,
                        utilidad_neta: 0,
                        flujo_operativo: 0,
                        margen_utilidad: 0
                    });
                    return;
                }

                // Obtener valores de finanzas
                const ventasNetas = Number(finanzas.ventas_netas) || 0;
                const comprasTotal = Number(finanzas.compras_total) || 0;
                const gastosOperativos = Number(finanzas.gastos_operativos_total) || 0;
                const utilidadNeta = Number(finanzas.utilidad_neta) || 0;

                // Calcular margen de utilidad
                const margenUtilidad = ventasNetas > 0 ? (utilidadNeta / ventasNetas) * 100 : 0;

                // Calcular Flujo Operativo: Ingresos del mes - Pagos del mes
                // Flujo Operativo = ventas_netas - (compras_total + gastos_operativos_total)
                const flujoOperativo = ventasNetas - (comprasTotal + gastosOperativos);

                // Actualizar KPIs
                actualizarKPIs({
                    ventas_netas: ventasNetas,
                    gastos_operativos_total: gastosOperativos,
                    compras_total: comprasTotal,
                    utilidad_neta: utilidadNeta,
                    flujo_operativo: flujoOperativo,
                    margen_utilidad: margenUtilidad
                });

            } catch (error) {
                console.error('Error en cargarKPIsFinancieros:', error);
                mostrarErrorKPIs();
            }
        }

        // Función para actualizar los elementos del DOM con los KPIs
        function actualizarKPIs(datos) {
            // Ventas del Mes
            const kpiVentasMes = document.getElementById('kpiVentasMes');
            if (kpiVentasMes) {
                kpiVentasMes.textContent = formatearMoneda(datos.ventas_netas);
            }

            // Gastos del Mes
            const kpiGastosMes = document.getElementById('kpiGastosMes');
            if (kpiGastosMes) {
                kpiGastosMes.textContent = formatearMoneda(datos.gastos_operativos_total);
            }

            // Compras del Mes
            const kpiComprasMes = document.getElementById('kpiComprasMes');
            if (kpiComprasMes) {
                kpiComprasMes.textContent = formatearMoneda(datos.compras_total);
            }

            // Flujo Operativo
            const kpiFlujoOperativoMes = document.getElementById('kpiFlujoOperativoMes');
            if (kpiFlujoOperativoMes) {
                kpiFlujoOperativoMes.textContent = formatearMoneda(datos.flujo_operativo);
                // Cambiar color según si es positivo o negativo
                if (datos.flujo_operativo >= 0) {
                    kpiFlujoOperativoMes.classList.remove('text-danger');
                    kpiFlujoOperativoMes.classList.add('text-success');
                } else {
                    kpiFlujoOperativoMes.classList.remove('text-success');
                    kpiFlujoOperativoMes.classList.add('text-danger');
                }
            }

            // Utilidad Neta
            const kpiUtilidadNetaMes = document.getElementById('kpiUtilidadNetaMes');
            if (kpiUtilidadNetaMes) {
                kpiUtilidadNetaMes.textContent = formatearMoneda(datos.utilidad_neta);
                // Cambiar color según si es positivo o negativo
                if (datos.utilidad_neta >= 0) {
                    kpiUtilidadNetaMes.classList.remove('text-danger');
                    kpiUtilidadNetaMes.classList.add('text-success');
                } else {
                    kpiUtilidadNetaMes.classList.remove('text-success');
                    kpiUtilidadNetaMes.classList.add('text-danger');
                }
            }

            // Margen de Utilidad
            const kpiMargenUtilidadMes = document.getElementById('kpiMargenUtilidadMes');
            if (kpiMargenUtilidadMes) {
                kpiMargenUtilidadMes.textContent = formatearPorcentaje(datos.margen_utilidad);
                // Cambiar color según el margen
                if (datos.margen_utilidad >= 20) {
                    kpiMargenUtilidadMes.classList.remove('text-danger', 'text-warning');
                    kpiMargenUtilidadMes.classList.add('text-success');
                } else if (datos.margen_utilidad >= 10) {
                    kpiMargenUtilidadMes.classList.remove('text-danger', 'text-success');
                    kpiMargenUtilidadMes.classList.add('text-warning');
                } else {
                    kpiMargenUtilidadMes.classList.remove('text-success', 'text-warning');
                    kpiMargenUtilidadMes.classList.add('text-danger');
                }
            }
        }

        // Función para mostrar error en los KPIs
        function mostrarErrorKPIs() {
            const elementos = ['kpiVentasMes', 'kpiGastosMes', 'kpiComprasMes', 'kpiFlujoOperativoMes', 'kpiUtilidadNetaMes', 'kpiMargenUtilidadMes'];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.textContent = 'Error';
                    elemento.classList.add('text-danger');
                }
            });
        }

        // Función para cargar KPIs operativos
        async function cargarKPIsOperativos() {
            try {
                if (!window.db || !window.supabaseClient) {
                    console.error('No hay conexión con el servicio de base de datos');
                    return;
                }

                // Obtener todas las finanzas mensuales para calcular ventas totales
                const { data: todasFinanzas, error: errorFinanzas } = await window.supabaseClient
                    .from('finanzas_mensuales')
                    .select('ventas_netas');

                // Obtener todos los gastos históricos de gastos_mensuales_detalle
                // Para KPIs Operativos, mostramos la suma total histórica de todos los gastos
                const { data: todosGastosDetalle, error: errorGastos } = await window.supabaseClient
                    .from('gastos_mensuales_detalle')
                    .select('monto')
                    .is('deleted_at', null); // Solo gastos no eliminados

                if (errorFinanzas) {
                    console.error('Error cargando finanzas totales:', errorFinanzas);
                }
                if (errorGastos) {
                    console.error('Error cargando gastos detalle:', errorGastos);
                }

                // Calcular la suma de todas las ventas netas
                let ventasTotales = 0;
                // Calcular la suma de todos los gastos desde gastos_mensuales_detalle
                // (suma histórica total de todos los gastos registrados)
                let gastosTotales = 0;
                
                // Sumar ventas de finanzas_mensuales
                if (todasFinanzas && Array.isArray(todasFinanzas)) {
                    todasFinanzas.forEach(finanza => {
                        ventasTotales += (Number(finanza.ventas_netas) || 0);
                    });
                }

                // Sumar todos los gastos históricos de gastos_mensuales_detalle
                if (todosGastosDetalle && Array.isArray(todosGastosDetalle)) {
                    todosGastosDetalle.forEach(gasto => {
                        gastosTotales += (Number(gasto.monto) || 0);
                    });
                }

                // Actualizar el KPI de Ventas Totales
                const kpiVentasTotales = document.getElementById('kpiVentasTotales');
                if (kpiVentasTotales) {
                    kpiVentasTotales.textContent = formatearMoneda(ventasTotales);
                    kpiVentasTotales.classList.remove('text-danger');
                }

                // Actualizar el KPI de Gastos Totales
                const kpiGastosTotales = document.getElementById('kpiGastosTotales');
                if (kpiGastosTotales) {
                    kpiGastosTotales.textContent = formatearMoneda(gastosTotales);
                    kpiGastosTotales.classList.remove('text-danger');
                }

                // Calcular Punto Equilibrio Total: Ventas Totales - Gastos Totales
                const puntoEquilibrioTotal = ventasTotales - gastosTotales;

                // Actualizar el KPI de Punto Equilibrio Total
                const kpiPuntoEquilibrioTotal = document.getElementById('kpiPuntoEquilibrioTotal');
                if (kpiPuntoEquilibrioTotal) {
                    kpiPuntoEquilibrioTotal.textContent = formatearMoneda(puntoEquilibrioTotal);
                    // Cambiar color según si es positivo o negativo
                    kpiPuntoEquilibrioTotal.classList.remove('text-danger', 'text-success', 'text-warning');
                    if (puntoEquilibrioTotal >= 0) {
                        kpiPuntoEquilibrioTotal.classList.add('text-success');
                    } else {
                        kpiPuntoEquilibrioTotal.classList.add('text-danger');
                    }
                }

            } catch (error) {
                console.error('Error en cargarKPIsOperativos:', error);
                const kpiVentasTotales = document.getElementById('kpiVentasTotales');
                const kpiGastosTotales = document.getElementById('kpiGastosTotales');
                const kpiPuntoEquilibrioTotal = document.getElementById('kpiPuntoEquilibrioTotal');
                if (kpiVentasTotales) {
                    kpiVentasTotales.textContent = 'Error';
                    kpiVentasTotales.classList.add('text-danger');
                }
                if (kpiGastosTotales) {
                    kpiGastosTotales.textContent = 'Error';
                    kpiGastosTotales.classList.add('text-danger');
                }
                if (kpiPuntoEquilibrioTotal) {
                    kpiPuntoEquilibrioTotal.textContent = 'Error';
                    kpiPuntoEquilibrioTotal.classList.add('text-danger');
                }
            }
        }

        // Variables globales para los gráficos
        let ventasMensualesChart = null;
        let ventasComparativasChart = null;
        let flujoOperativoChart = null;
        let cargandoKPIsComparativos = false; // Bandera para prevenir múltiples cargas
        let cargandoVentasComparativas = false; // Bandera para prevenir múltiples cargas del gráfico comparativo
        let cargandoFlujoOperativo = false; // Bandera para prevenir múltiples cargas del gráfico de flujo operativo

        // Función para inicializar el selector de año
        function inicializarSelectorAnio() {
            const selectAnio = document.getElementById('selectAnioVentas');
            if (!selectAnio) return;

            // Obtener año actual
            const anioActual = new Date().getFullYear();
            
            // Generar opciones de años (desde 2020 hasta 5 años en el futuro)
            const anioInicio = 2020;
            const anioFin = anioActual + 5;
            
            selectAnio.innerHTML = '';
            for (let anio = anioFin; anio >= anioInicio; anio--) {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                if (anio === anioActual) {
                    option.selected = true;
                }
                selectAnio.appendChild(option);
            }

            // Agregar event listener para actualizar el gráfico cuando cambie el año
            selectAnio.addEventListener('change', function() {
                const anioSeleccionado = parseInt(this.value);
                if (anioSeleccionado) {
                    cargarKPIsComparativos(anioSeleccionado);
                }
            });
        }

        // Función para inicializar el selector de año del gráfico de flujo operativo
        function inicializarSelectorAnioFlujoOperativo() {
            const selectAnio = document.getElementById('selectAnioFlujoOperativo');
            if (!selectAnio) return;

            // Obtener año actual
            const anioActual = new Date().getFullYear();
            
            // Generar opciones de años (desde 2020 hasta 5 años en el futuro)
            const anioInicio = 2020;
            const anioFin = anioActual + 5;
            
            selectAnio.innerHTML = '';
            for (let anio = anioFin; anio >= anioInicio; anio--) {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                if (anio === anioActual) {
                    option.selected = true;
                }
                selectAnio.appendChild(option);
            }

            // Agregar event listener para actualizar el gráfico cuando cambie el año
            selectAnio.addEventListener('change', function() {
                const anioSeleccionado = parseInt(this.value);
                if (anioSeleccionado) {
                    cargarFlujoOperativoMensual(anioSeleccionado);
                }
            });
        }

        // Función para cargar el gráfico de flujo operativo mensual
        async function cargarFlujoOperativoMensual(anio = null) {
            // Prevenir múltiples ejecuciones simultáneas
            if (cargandoFlujoOperativo) {
                return;
            }

            try {
                cargandoFlujoOperativo = true;

                if (!window.db || !window.supabaseClient) {
                    console.error('No hay conexión con el servicio de base de datos');
                    return;
                }

                // Si no se proporciona año, usar el año actual o el seleccionado
                if (!anio) {
                    const selectAnio = document.getElementById('selectAnioFlujoOperativo');
                    anio = selectAnio ? parseInt(selectAnio.value) : new Date().getFullYear();
                }

                // Obtener datos de finanzas mensuales del año seleccionado (todos los meses)
                // Nota: gastos_operativos_total ya incluye los gastos de gastos_mensuales_detalle
                // gracias a los triggers de la base de datos, por lo que no es necesario consultarlos por separado
                const { data: finanzasRango, error: errorFinanzas } = await window.db.getFinanzasMensualesRango(anio, 1, 12);

                if (errorFinanzas) {
                    console.error('Error cargando finanzas mensuales rango:', errorFinanzas);
                }

                // Preparar datos para el gráfico
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const ventasMensuales = new Array(12).fill(0);
                const gastosMensuales = new Array(12).fill(0);
                const flujoOperativoMensual = new Array(12).fill(0);

                // Mapear los datos recibidos de finanzas_mensuales
                // gastos_operativos_total ya incluye todos los gastos de gastos_mensuales_detalle
                // gracias a los triggers de la base de datos
                if (finanzasRango && Array.isArray(finanzasRango)) {
                    finanzasRango.forEach(finanza => {
                        const mes = finanza.mes - 1; // Los meses en el array son 0-indexed
                        if (mes >= 0 && mes < 12) {
                            const ventas = Number(finanza.ventas_netas) || 0;
                            const gastosOperativos = Number(finanza.gastos_operativos_total) || 0;
                            const compras = Number(finanza.compras_total) || 0;
                            // Gastos totales = gastos operativos (ya incluye gastos_mensuales_detalle) + compras
                            const gastosTotales = gastosOperativos + compras;

                            ventasMensuales[mes] = ventas;
                            gastosMensuales[mes] = gastosTotales;
                        }
                    });
                }

                // Calcular flujo operativo mensual (ventas - gastos totales)
                for (let i = 0; i < 12; i++) {
                    flujoOperativoMensual[i] = ventasMensuales[i] - gastosMensuales[i];
                }

                // Crear o actualizar el gráfico de barras
                inicializarGraficoFlujoOperativo(meses, ventasMensuales, gastosMensuales, flujoOperativoMensual);

            } catch (error) {
                console.error('Error en cargarFlujoOperativoMensual:', error);
            } finally {
                cargandoFlujoOperativo = false;
            }
        }

        // Función para inicializar el gráfico de flujo operativo
        function inicializarGraficoFlujoOperativo(meses, ventas, gastos, flujoOperativo) {
            const canvas = document.getElementById('flujoOperativoChart');
            if (!canvas) return;

            // Destruir gráfico anterior si existe
            if (flujoOperativoChart) {
                flujoOperativoChart.destroy();
                flujoOperativoChart = null;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // Detectar tamaño de pantalla para ajustar el gráfico
            const isMobile = window.innerWidth < 768;
            const isTablet = window.innerWidth >= 768 && window.innerWidth < 992;

            flujoOperativoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Ventas (Ingresos)',
                            data: ventas,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)', // Azul
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        },
                        {
                            label: 'Gastos Totales (Operativos + Compras)',
                            data: gastos,
                            backgroundColor: 'rgba(220, 53, 69, 0.6)', // Rojo
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        },
                        {
                            label: 'Flujo Operativo',
                            data: flujoOperativo,
                            backgroundColor: 'rgba(40, 167, 69, 0.6)', // Verde
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: isMobile ? 1.2 : isTablet ? 2.0 : 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 11 : 12
                                },
                                padding: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatearMoneda(context.parsed.y);
                                }
                            },
                            titleFont: {
                                size: isMobile ? 11 : 12
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 11
                            },
                            padding: isMobile ? 8 : 12
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxTicksLimit: isMobile ? 6 : 10,
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '$' + value;
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Función para cargar KPIs comparativos
        async function cargarKPIsComparativos(anio = null) {
            // Prevenir múltiples ejecuciones simultáneas
            if (cargandoKPIsComparativos) {
                return;
            }

            try {
                cargandoKPIsComparativos = true;

                if (!window.db || !window.supabaseClient) {
                    console.error('No hay conexión con el servicio de base de datos');
                    return;
                }

                // Si no se proporciona año, usar el año actual o el seleccionado
                if (!anio) {
                    const selectAnio = document.getElementById('selectAnioVentas');
                    anio = selectAnio ? parseInt(selectAnio.value) : new Date().getFullYear();
                }

                // Obtener datos de finanzas mensuales del año seleccionado (todos los meses)
                const { data: finanzasRango, error } = await window.db.getFinanzasMensualesRango(anio, 1, 12);

                if (error) {
                    console.error('Error cargando finanzas mensuales rango:', error);
                    return;
                }

                // Preparar datos para el gráfico
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const ventasMensuales = new Array(12).fill(0);

                // Mapear los datos recibidos
                if (finanzasRango && Array.isArray(finanzasRango)) {
                    finanzasRango.forEach(finanza => {
                        const mes = finanza.mes - 1; // Los meses en el array son 0-indexed
                        if (mes >= 0 && mes < 12) {
                            ventasMensuales[mes] = Number(finanza.ventas_netas) || 0;
                        }
                    });
                }

                // Crear o actualizar el gráfico de barras
                inicializarGraficoVentasMensuales(meses, ventasMensuales);

            } catch (error) {
                console.error('Error en cargarKPIsComparativos:', error);
            } finally {
                cargandoKPIsComparativos = false;
            }
        }

        // Función para inicializar el gráfico de ventas mensuales
        function inicializarGraficoVentasMensuales(meses, ventas) {
            const canvas = document.getElementById('ventasMensualesChart');
            if (!canvas) return;

            // Destruir gráfico anterior si existe
            if (ventasMensualesChart) {
                ventasMensualesChart.destroy();
                ventasMensualesChart = null;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // Detectar tamaño de pantalla para ajustar el gráfico
            const isMobile = window.innerWidth < 768;
            const isTablet = window.innerWidth >= 768 && window.innerWidth < 992;

            ventasMensualesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Ventas Netas (COP)',
                        data: ventas,
                        backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: isMobile ? 1.2 : isTablet ? 2.0 : 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 11 : 12
                                },
                                padding: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Ventas: ' + formatearMoneda(context.parsed.y);
                                }
                            },
                            titleFont: {
                                size: isMobile ? 11 : 12
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 11
                            },
                            padding: isMobile ? 8 : 12
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxTicksLimit: isMobile ? 6 : 10,
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '$' + value;
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Función para inicializar los selectores de años comparativos
        function inicializarSelectoresComparativos() {
            const selectAnio1 = document.getElementById('selectAnioComparativo1');
            const selectAnio2 = document.getElementById('selectAnioComparativo2');
            if (!selectAnio1 || !selectAnio2) return;

            // Obtener año actual
            const anioActual = new Date().getFullYear();
            const anioAnterior = anioActual - 1;
            
            // Generar opciones de años (desde 2020 hasta 5 años en el futuro)
            const anioInicio = 2020;
            const anioFin = anioActual + 5;
            
            // Limpiar y llenar ambos selectores
            [selectAnio1, selectAnio2].forEach((select, index) => {
                select.innerHTML = '';
                for (let anio = anioFin; anio >= anioInicio; anio--) {
                    const option = document.createElement('option');
                    option.value = anio;
                    option.textContent = anio;
                    select.appendChild(option);
                }
            });

            // Establecer valores por defecto: año actual y año anterior
            selectAnio1.value = anioAnterior;
            selectAnio2.value = anioActual;

            // Agregar event listeners para actualizar el gráfico cuando cambien los años
            selectAnio1.addEventListener('change', function() {
                const anio1 = parseInt(this.value);
                const anio2 = parseInt(selectAnio2.value);
                if (anio1 && anio2 && anio1 !== anio2) {
                    cargarVentasComparativas(anio1, anio2);
                }
            });

            selectAnio2.addEventListener('change', function() {
                const anio1 = parseInt(selectAnio1.value);
                const anio2 = parseInt(this.value);
                if (anio1 && anio2 && anio1 !== anio2) {
                    cargarVentasComparativas(anio1, anio2);
                }
            });
        }

        // Función para cargar ventas comparativas entre dos años
        async function cargarVentasComparativas(anio1 = null, anio2 = null) {
            // Prevenir múltiples ejecuciones simultáneas
            if (cargandoVentasComparativas) {
                return;
            }

            try {
                cargandoVentasComparativas = true;

                if (!window.db || !window.supabaseClient) {
                    console.error('No hay conexión con el servicio de base de datos');
                    return;
                }

                // Si no se proporcionan años, usar los valores de los selectores
                if (!anio1 || !anio2) {
                    const selectAnio1 = document.getElementById('selectAnioComparativo1');
                    const selectAnio2 = document.getElementById('selectAnioComparativo2');
                    anio1 = selectAnio1 ? parseInt(selectAnio1.value) : new Date().getFullYear() - 1;
                    anio2 = selectAnio2 ? parseInt(selectAnio2.value) : new Date().getFullYear();
                }

                // Validar que los años sean diferentes
                if (anio1 === anio2) {
                    console.warn('Los años deben ser diferentes');
                    return;
                }

                // Obtener datos de ambos años en paralelo
                const [resultado1, resultado2] = await Promise.all([
                    window.db.getFinanzasMensualesRango(anio1, 1, 12),
                    window.db.getFinanzasMensualesRango(anio2, 1, 12)
                ]);

                if (resultado1.error) {
                    console.error('Error cargando finanzas mensuales año 1:', resultado1.error);
                    return;
                }

                if (resultado2.error) {
                    console.error('Error cargando finanzas mensuales año 2:', resultado2.error);
                    return;
                }

                // Preparar datos para el gráfico
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                const ventasAnio1 = new Array(12).fill(0);
                const ventasAnio2 = new Array(12).fill(0);

                // Mapear los datos del año 1
                if (resultado1.data && Array.isArray(resultado1.data)) {
                    resultado1.data.forEach(finanza => {
                        const mes = finanza.mes - 1;
                        if (mes >= 0 && mes < 12) {
                            ventasAnio1[mes] = Number(finanza.ventas_netas) || 0;
                        }
                    });
                }

                // Mapear los datos del año 2
                if (resultado2.data && Array.isArray(resultado2.data)) {
                    resultado2.data.forEach(finanza => {
                        const mes = finanza.mes - 1;
                        if (mes >= 0 && mes < 12) {
                            ventasAnio2[mes] = Number(finanza.ventas_netas) || 0;
                        }
                    });
                }

                // Crear o actualizar el gráfico comparativo
                inicializarGraficoVentasComparativas(meses, ventasAnio1, ventasAnio2, anio1, anio2);

            } catch (error) {
                console.error('Error en cargarVentasComparativas:', error);
            } finally {
                cargandoVentasComparativas = false;
            }
        }

        // Función para inicializar el gráfico comparativo de ventas
        function inicializarGraficoVentasComparativas(meses, ventasAnio1, ventasAnio2, anio1, anio2) {
            const canvas = document.getElementById('ventasComparativasChart');
            if (!canvas) return;

            // Destruir gráfico anterior si existe
            if (ventasComparativasChart) {
                ventasComparativasChart.destroy();
                ventasComparativasChart = null;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // Detectar tamaño de pantalla para ajustar el gráfico
            const isMobile = window.innerWidth < 768;
            const isTablet = window.innerWidth >= 768 && window.innerWidth < 992;

            ventasComparativasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: `Ventas ${anio1}`,
                            data: ventasAnio1,
                            backgroundColor: 'rgba(40, 167, 69, 0.6)', // Verde
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        },
                        {
                            label: `Ventas ${anio2}`,
                            data: ventasAnio2,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)', // Azul
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: isMobile ? 1.2 : isTablet ? 2.0 : 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 11 : 12
                                },
                                padding: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatearMoneda(context.parsed.y);
                                }
                            },
                            titleFont: {
                                size: isMobile ? 11 : 12
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 11
                            },
                            padding: isMobile ? 8 : 12
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxTicksLimit: isMobile ? 6 : 10,
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '$' + value;
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Ventas
        function inicializarGraficos() {
            // Gráfico de Ventas por Día
            const ventasCtx = document.getElementById('ventasChart').getContext('2d');
            new Chart(ventasCtx, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                    datasets: [{
                        label: 'Ventas ($)',
                        data: [180000, 220000, 190000, 250000, 300000, 280000, 320000],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'K';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

        }

        // Cambiar período del gráfico
        function cambiarPeriodo(periodo) {
            // Remover clase active de todos los botones
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Agregar clase active al botón clickeado
            event.target.classList.add('active');
            
            // Aquí se actualizaría el gráfico según el período seleccionado
            console.log('Cambiando período a:', periodo);
        }

        // Actualizar dashboard
        async function actualizarDashboard() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
            btn.disabled = true;
            
            try {
                // Actualizar fecha
                const fecha = new Date();
                const opciones = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                document.getElementById('fechaActual').textContent = fecha.toLocaleDateString('es-ES', opciones);
                
                // Recargar KPIs financieros
                await cargarKPIsFinancieros();
                
                // Recargar KPIs operativos
                await cargarKPIsOperativos();
                
                // Recargar KPIs comparativos
                await cargarKPIsComparativos();
                
                // Recargar gráfico comparativo de años
                await cargarVentasComparativas();
                
                // Recargar gráfico de flujo operativo
                await cargarFlujoOperativoMensual();
                
                // Recargar gráficos (si es necesario)
                // inicializarGraficos();
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Mostrar mensaje de éxito
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
                toast.style.zIndex = '9999';
                toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>Dashboard actualizado correctamente';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
                
            } catch (error) {
                console.error('Error actualizando dashboard:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                alert('Error al actualizar el dashboard. Por favor, intente nuevamente.');
            }
        }
    </script>
</body>
</html>
